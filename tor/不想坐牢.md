# 不想坐牢

---

 1. 系统代理 vs. 全局代理
- 系统代理：
  - 定义：操作系统设置的代理（如 Windows 的「Internet 选项」或 macOS 的「网络代理」），影响所有支持代理协议的应用（如浏览器、邮件客户端等）。
  - 范围：仅作用于 显式支持代理设置的应用，部分应用（如命令行工具、游戏、UDP 服务）可能忽略系统代理。
  - 示例：在 Windows 中设置 `127.0.0.1:7890` 为系统代理后，Chrome 会通过该代理访问网络，但 `ping` 命令仍直连。

- 全局代理：
  - 定义：通过 VPN、透明代理或流量劫持技术，强制 所有流量（包括 TCP/UDP/ICMP）通过代理服务器。
  - 范围：覆盖所有应用和协议，无例外。
  - 工具示例：`OpenVPN`、`Tun2socks`、`Proxifier`。

---

 2. Clash 的「系统代理」模式
- 行为特性：
  - Clash 开启「系统代理」后，会在操作系统中注册代理设置（如 HTTP/HTTPS/SOCKS 代理地址 `127.0.0.1:7890`）。
  - 仅影响支持代理的应用：如浏览器、部分下载工具等，但命令行工具（如 `curl`、`nmap`）需手动配置代理参数。
  - 非全局代理：UDP 流量、低层协议（如 ICMP）、不遵循系统代理的应用（如某些游戏）仍会直连。

- 验证方法：
  bash
   检查系统代理是否生效（部分系统需重启应用）
  curl -x http://127.0.0.1:7890 https://ipinfo.io/ip   应返回 Clash 出口 IP

---

 3. 扫描工具叠加 Tor 代理的流量路径
假设场景：  
- Clash 开启系统代理（`127.0.0.1:7890`）。  
- 扫描工具显式配置 Tor 代理（`socks5://127.0.0.1:9050`）。

- 流量路径分析：
  - 路径 1（默认行为）：  
    扫描工具 → Tor 代理 → 直连互联网（绕过 Clash 系统代理）。  
    - 原因：应用显式指定代理时，通常优先使用自身设置，忽略系统代理。
    - 结果：流量仅通过 Tor，不经过 Clash。

  - 路径 2（如需链式代理）：  
    扫描工具 → Tor 代理 → Clash 代理 → 互联网。  
    - 实现方式：需在扫描工具中配置代理链，例如：
      bash
       使用 proxychains 强制链式代理
      proxychains nmap -sT target.com
    - 配置文件（`proxychains.conf`）：
      ini
      strict_chain
      proxy_dns
      ProxyList
      socks5 127.0.0.1 9050   Tor 代理
      http 127.0.0.1 7890     Clash 代理

---

 4. 潜在问题与风险
1. 匿名性破坏：
   - 路径 1：仅通过 Tor，匿名性高，但可能被目标服务器屏蔽。  
   - 路径 2：流量经过 Clash 后，Clash 的出口节点可能记录 Tor 流量，泄露匿名性。

2. 性能下降：
   - 多层代理增加延迟（Tor → Clash 或反之），影响扫描速度。

3. 配置冲突：
   - 若同时开启系统代理和应用代理，可能因规则重叠导致循环或失效。

---

 5. 正确配置建议
- 场景 1：仅需 Tor 匿名  
  - 关闭 Clash 系统代理，扫描工具直接配置 Tor 代理（`socks5://127.0.0.1:9050`）。
  - 优点：流量完全通过 Tor，匿名性最高。  
  - 缺点：Tor 速度较慢，可能被目标防火墙拦截。

- 场景 2：需 Tor + Clash 分流  
  - 在 Clash 规则中设置 Tor 流量直连，其他流量走代理：
    yaml
     Clash 配置文件（config.yaml）
    rules:
      - DOMAIN-SUFFIX,onion,DIRECT       洋葱服务直连（需 Tor 独立运行）
      - GEOIP,CN,DIRECT                 国内流量直连
      - MATCH,PROXY                      其他流量走代理
  - 优点：灵活分流，避免 Tor 流量二次代理。  
  - 缺点：需手动维护复杂规则。

- 场景 3：链式代理（Tor → Clash）  
  - 使用 `proxychains` 明确代理顺序，确保扫描工具流量先走 Tor，再经 Clash：
    ini
     proxychains.conf
    strict_chain
    ProxyList
    socks5 127.0.0.1 9050   Tor 第一跳
    http 127.0.0.1 7890      Clash 第二跳
  - 验证命令：
    bash
    proxychains curl https://ipinfo.io/ip   应显示 Clash 出口 IP

---

 6. 流量验证工具
1. IP 检测：
   bash
    直接检测出口 IP
   curl https://ipinfo.io/ip

    通过 Clash 检测
   curl -x http://127.0.0.1:7890 https://ipinfo.io/ip

    通过 Tor 检测
   curl -x socks5://127.0.0.1:9050 https://ipinfo.io/ip

2. 流量抓包分析：
   bash
    使用 Wireshark 或 tcpdump 监控流量走向
   tcpdump -i any port 7890 or port 9050 -n

---

 总结
- 系统代理 ≠ 全局代理：仅影响支持代理的应用，需手动处理例外。  
- 代理叠加风险：匿名性可能因多层出口节点泄露，优先使用单一代理（如仅 Tor）。  
- 推荐实践：分场景配置，用 `proxychains` 明确代理链，定期验证 IP 和流量路径。